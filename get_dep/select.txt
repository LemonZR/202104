--<metadata>
--<model_name>: 集团客户流失预警月表
--<keyword>: 集客, 集团客户流失预警
--<description>: 集团客户流失预警月表
--<author>: 李明志@华为
--<run_cycle>: M
--<tmp_table>: hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1,hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2,hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3,hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4
--<tmp_table>: hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5
--<det_table>: PUB.TDET_LSYJ_CUST_FALSE_LIST
--<app_table>: MK.TM_GC_GRP_RUNOFF_M
--<app_name>:
--</metadata>

drop table  if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1;
CREATE  TABLE IF NOT EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1
(
region_code varchar(5)---- 地市
,cust_id varchar(20)---- 集团ID
,info_income decimal(20,2)---- 信息化收入
,prod_subs int---- 集团成员数
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS RCFILE;

truncate table hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1;
----插表

INSERT INTO hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1
select
a.region_code ---- 地市
,a.cust_id ---- 集团ID
,sum(a.info_income)---- 信息化收入
,0---- 集团成员数
 from mk.tm_gc_grp_income_m a
where a.statis_month = ${hivevar:vi_month}
and a.group_type in ('grouptypeA1','grouptypeA2','grouptypeB1','grouptypeB2','grouptypeC','grouptypeTemp')
and (a.cust_status in ('stcmNml','stcmLtnt','stcmLost')
or (a.cust_status not in ('stcmNml','stcmLtnt','stcmLost')
and substr(a.cust_status_date,1,6) = cast(${hivevar:vi_month}
 as string)))
group by a.region_code,
a.cust_id having sum(info_income)>0;


----集团产品成员数
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2;
CREATE  TABLE IF NOT EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2
(
 region_code varchar(5)---- 地市
,cust_id varchar(20)---- 集团ID
,prod_subs int---- 集团成员数
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS RCFILE;

truncate table hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2;



INSERT INTO hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2
select
region_code,
cust_id,
count(distinct subs_id ) prod_subs
 from mk.tm_gc_prod_info_m
where statis_month = ${hivevar:vi_month}
and data_source = '1'
and group_type in ('grouptypeA1','grouptypeA2','grouptypeB1','grouptypeB2','grouptypeC','grouptypeTemp')
and (cust_status in ('stcmNml','stcmLtnt','stcmLost')
or(cust_status not in ('stcmNml','stcmLtnt','stcmLost') and substr(cust_status_date,1,6) = cast(${hivevar:vi_month}
 as string))
)
group by region_code, cust_id;

-----更新集团产品成员数
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3;
CREATE  TABLE IF NOT EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3
(
region_code varchar(5)---- 地市
,cust_id varchar(20)---- 集团ID
,info_income decimal(20,2)---- 信息化收入
,prod_subs int---- 集团成员数
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS RCFILE;

truncate table hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3;

insert into hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3
	select
	a.region_code ---- 地市
	,a.cust_id ---- 集团ID
	,a.info_income---- 信息化收入
	,case when b.region_code is not null  and b.cust_id is not null then b.prod_subs else a.prod_subs end ---- 集团成员数
	from hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1 a
	left join hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2 b
	 on a.region_code = b.region_code and a.cust_id = b.cust_id;



--- 插入集团产品成员数;
INSERT INTO hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3
select
b.region_code,
b.cust_id,
0,
b.prod_subs
from (
select
region_code,
cust_id,
count(distinct subs_id) prod_subs from mk.tm_gc_prod_info_m
where statis_month = ${hivevar:vi_month}
and data_source = '1'
and group_type in ('grouptypeA1','grouptypeA2','grouptypeB1','grouptypeB2','grouptypeC','grouptypeTemp')
and (cust_status in ('stcmNml','stcmLtnt','stcmLost')
or (cust_status not in ('stcmNml','stcmLtnt','stcmLost') and substr(cust_status_date,1,6) = cast(${hivevar:vi_month}
 as string))
)
group by region_code, cust_id
) b
left join hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3 as a on a.region_code = b.region_code and a.cust_id = b.cust_id
where a.region_code is null;
----信息化收入为0并且成员数大于等于10的集团

drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4;

CREATE  TABLE IF NOT EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4
(
region_code varchar(5)---- 地市
,cust_id varchar(20)---- 集团ID
,info_income decimal(20,2)---- 信息化收入
,prod_subs int---- 集团成员数
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS RCFILE;

truncate table hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4;

INSERT INTO hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4
select
a.region_code ---- 地市
,a.cust_id ---- 集团ID
,a.info_income---- 信息化收入
,a.prod_subs ---- 集团成员数
from hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3 a
where info_income = 0
and ((region_code <> '312' and prod_subs <=10)
or (region_code = '312' and prod_subs <=3)--保定单独口径
);



----更新成员数,删除信息化收入为0并且成员数大于等于10的集团
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5;

CREATE  TABLE IF NOT EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5
(
region_code varchar(5)---- 地市
,cust_id varchar(20)---- 集团ID
,info_income decimal(20,2)---- 信息化收入
,prod_subs int---- 集团成员数
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS RCFILE;

truncate table hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5;

INSERT INTO hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5
select
a.region_code---- 地市
,a.cust_id---- 集团ID
,a.info_income---- 信息化收入
,a.prod_subs---- 集团成员数
from hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3 a
left join hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4 b
on a.region_code=b.region_code and a.cust_id =b.cust_id
where b.cust_id is null;
----插入目标表


----删除表加分区
ALTER TABLE mk.tm_gc_grp_runoff_m DROP IF EXISTS partition(statis_month=${hivevar:vi_month});


insert into mk.tm_gc_grp_runoff_m
partition(statis_month=${hivevar:vi_month}
)
select
a.region_code,
a.cust_id,
a.info_income,
a.prod_subs
 from hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5  a
left join PUB.TDET_LSYJ_CUST_FALSE_LIST b  ----过滤掉虚假集团客户
on a.cust_id = b.cust_id
where b.cust_id is null;

drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID1;
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID2;
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID3;
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID4;
drop table if EXISTS hw_tmp.TM_GRP_LSYJ_BASE_CUST_M_MID5;