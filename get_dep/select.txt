--<metadata>
--<model_name>:携转累计明细汇总（支撑携转通报）
--<keyword>: 携转累计明细汇总（支撑携转通报）
--<description>: 携转累计明细汇总（支撑携转通报）
--<author>: 牛贞琪@华为
--<run_cycle>: D
--<tmp_table>: hw_tmp.tc_gc_xz_arpmodo_collect_m
--<det_table>: dis.tc_gc_xz_arpmodo_detail_m
--<app_table>: dis_pc_gc_xz_arpmodo_collect_m
--<app_name>: /路径/子路径/应用专题1/应用1
--</metadata>

create table if not exists hw_tmp.tc_gc_xz_arpmodo_collect_m
(
statis_month 	integer,
region_code 	varchar(20),
transin_arpu 	decimal(20,2),
transin_mou 	decimal(20,2),
transin_dou 	decimal(20,2),
transout_arpu 	decimal(20,2),
transout_mou 	decimal(20,2),
transout_dou 	decimal(20,2),
trans_month     integer
)engine=express distributed by('region_code') default charset=utf8 tablespace='sys_tablespace';
insert into dis.tc_gc_xz_arpmodo_collect_m
select
${gbvar:vi_month}
,region_code
,max(arpu1/subs_id1)
,max(mou1/subs_id1)
,max(dou1/subs_id1)
,max(arpu2/subs_id2)
,max(mou2/subs_id2)
,max(dou2/subs_id2)
from
    (select region_code
    ,count(distinct case when trans_type = '携入客户' then subs_id end) subs_id1
    ,sum(case when trans_type = '携入客户' then arpu end) arpu1
	,sum(case when trans_type = '携入客户' then mou end) mou1
	,sum(case when trans_type = '携入客户' then dou end) dou1
    ,count(distinct case when trans_type = '携出客户' then subs_id end) subs_id2
    ,sum(case when trans_type = '携出客户' then arpu end) arpu2
	,sum(case when trans_type = '携出客户' then mou end) mou2
	,sum(case when trans_type = '携出客户' then dou end) dou2
    from dis.tc_gc_xz_arpmodo_detail_m
	where statis_month = ${gbvar:vi_month}
	group by region_code
    ) a
group  by
region_code
,arpu1/subs_id1
,mou1/subs_id1
,dou1/subs_id1
,arpu2/subs_id2
,mou2/subs_id2
,dou2/subs_id2
;
insert into hw_tmp.tc_gc_xz_arpmodo_collect_m
select
${gbvar:vi_month}
,'全省'
,arpu1/subs_id1
,mou1/subs_id1
,dou1/subs_id1
,arpu2/subs_id2
,mou2/subs_id2
,dou2/subs_id2
from
    (select
    count(distinct case when trans_type = '携入客户' then subs_id end) subs_id1
    ,sum(case when trans_type = '携入客户' then arpu end) arpu1
	,sum(case when trans_type = '携入客户' then mou end) mou1
	,sum(case when trans_type = '携入客户' then dou end) dou1
    ,count(distinct case when trans_type = '携出客户' then subs_id end) subs_id2
    ,sum(case when trans_type = '携出客户' then arpu end) arpu2
	,sum(case when trans_type = '携出客户' then mou end) mou2
	,sum(case when trans_type = '携出客户' then dou end) dou2
    from dis.tc_gc_xz_arpmodo_detail_m
	where statis_month = ${gbvar:vi_month}
    ) a
;

create table if not exists dis.tc_gc_xz_arpmodo_collect_m
(
statis_month 	integer,
region_code 	varchar(20),
transin_arpu 	decimal(20,2),
transin_mou 	decimal(20,2),
transin_dou 	decimal(20,2),
transout_arpu 	decimal(20,2),
transout_mou 	decimal(20,2),
transout_dou 	decimal(20,2)
)engine=express distributed by('region_code') default charset=utf8 tablespace='sys_tablespace';
insert into dis.tc_gc_xz_arpmodo_collect_m
select
statis_month
,region_code
,transin_arpu
,transin_mou
,transin_dou
,transout_arpu
,transout_mou
,transout_dou
from hw_tmp.tc_gc_xz_arpmodo_collect_m
where statis_month = ${gbvar:vi_month}
order by region_code;