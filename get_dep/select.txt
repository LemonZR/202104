--<metadata>
--<model_name>: 集团基础资料日表
--<keyword>: 集客, 集团基础资料
--<description>: 集团基础资料日表
--<author>: 刘昆杨@华为
--<run_cycle>: D
--<tmp_table>: hw_tmp.tmp_tm_gc_grp_d_mid1,hw_tmp.tmp_tm_gc_grp_d_mid2,hw_tmp.tmp_tm_gc_grp_d_mid3,hw_tmp.tmp_tm_gc_grp_d_mid4,hw_tmp.tmp_tm_gc_grp_d_mid5
--<det_table>: pub.tdet_grp_lfsqt
--<app_table>: MK.TM_GC_GRP_D
--<app_name>:
--</metadata>

drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid1;
create table hw_tmp.tmp_tm_gc_grp_d_mid1
(region_code varchar(5),
cust_id varchar(20),
cust_name varchar(500),
cust_orgid varchar(20),
respns_cust_mgr varchar(50),
cust_crt_date varchar(14),
cust_status varchar(10),
cust_status_date varchar(14),
group_id varchar(20),
group_type varchar(20),
cust_vacation_1 varchar(30),
cust_vacation_2 varchar(30),
stress_trade_type varchar(20),
staff_cnt bigint,
addr varchar(100),
checkin_date timestamp,
off_net_date timestamp,
grp_on_net_dur int,
grp_trade_type varchar(32),
grp_pay_type varchar(16),
supr_grp_id varchar(20),
cust_type string
)
row format delimited
fields terminated by '\t'
stored as rcfile;

----928180
insert into hw_tmp.tmp_tm_gc_grp_d_mid1
select
a.region_code,
a.cust_id,
a.cust_name,
coalesce(a.country_id,case a.region_code
when '310' then 'HB.HD'
when '311' then 'HB.SJ'
when '312' then 'HB.BD'
when '313' then 'HB.ZJ'
when '314' then 'HB.CD'
when '315' then 'HB.TS'
when '316' then 'HB.LF'
when '317' then 'HB.CZ'
when '318' then 'HB.HS'
when '319' then 'HB.XT'
when '335' then 'HB.QH'
when '336' then 'HB.XA'
end),
a.prncp_cust_magr,----大客户经理
a.create_date cust_crt_date,----客户创建时间
a.status,----客户状态
a.status_date,----客户状态变更时间
b.grp_cust_id,
b.corp_size,
b.trade_prop1 ,
b.trade_prop2,
b.disastervocation,
b.staff_cnt,
b.hqlocat addr,
from_unixtime( unix_timestamp(b.checkin_date,'yyyyMMddHHmmss'),'yyyy-MM-dd') checkin_date,
from_unixtime( unix_timestamp(b.to_on_net_time,'yyyyMMddHHmmss'),'yyyy-MM-dd HH:mm:ss') off_net_date,
datediff(from_unixtime(unix_timestamp('${hivevar:vi_day}','yyyyMMdd'),'yyyy-MM-dd'),from_unixtime(unix_timestamp(checkin_date,'yyyyMMddHHmmss'),'yyyy-MM-dd')) grp_on_net_dur,
b.trade_type3 grp_trade_type ,
b.grp_pay_mode grp_pay_type,
b.supr_grp_id supr_grp_id,
a.cust_type
from dwh.td_ci_cust_d a
join dwh.td_gc_group_cust_d b
on a.region_code=b.region_code
and a.cust_id = b.cust_id
and b.deal_date=${hivevar:vi_day}
and b.region_code<>'999'
left join pub.tdet_grp_lfsqt c
on c.cust_id=a.cust_id
and a.region_code = '316'
where a.deal_date=${hivevar:vi_day}
and a.region_code<>'999'
and c.cust_id is null
;


----优先用该表的客户经理
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid2;

create table hw_tmp.tmp_tm_gc_grp_d_mid2
(
cust_id varchar(20),
respns_cust_mgr varchar(50))
row format delimited
fields terminated by '\t'
stored as rcfile;

insert into hw_tmp.tmp_tm_gc_grp_d_mid2
select aa1.cust_id,aa1.custmgr from
(select trim(cast(custid as varchar(50))) cust_id,custmgr from
(select custid,custmgr,
row_number() over(partition by  custid order by case role when 'Master' then 1 when 'Assist' then 2 else 3 end) rownumber
from  dwh.td_gc_cust_servchannel_d where  deal_date=${hivevar:vi_day}) a
where  a.rownumber = 1) aa1
join hw_tmp.tmp_tm_gc_grp_d_mid1 a
on aa1.cust_id=a.cust_id where  a.cust_id is not null;


----3个标记字段
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid3;

create table  hw_tmp.tmp_tm_gc_grp_d_mid3
(cust_id varchar(20),
is_grp_cust_arr_cnt varchar(1),
is_grp_cust_new_cnt varchar(1),
is_grp_cust_lost_cnt varchar(1))
row format delimited
fields terminated by '\t'
stored as rcfile;

insert into hw_tmp.tmp_TM_GC_GRP_D_mid3
select distinct
 a.grp_cust_id,
 '1',
case when SUBSTR(B.cust_crt_date,1,8)=${hivevar:vi_day} and B.cust_status = 'stcmNml' then '1' else '0' end,
case when SUBSTR(B.cust_crt_date,1,8)=${hivevar:vi_day} and B.cust_status <> 'stcmNml' then '1' else '0' end
--from hw_tmp.tmp_tm_gc_grp_d_mid11 a
from mk.tm_gc_prod_order_d a
join hw_tmp.tmp_tm_gc_grp_d_mid1 b
on a.grp_cust_id = b.cust_id
where b.cust_type = 'GroupCustomer'
and a.statis_date =${hivevar:vi_day} ;



drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid4;
create table  hw_tmp.tmp_tm_gc_grp_d_mid4
(cust_id varchar(20),
grp_member_call_cnt bigint,
grp_member_call_dur bigint,
grp_member_gprs_flux bigint,
grp_member_cnt bigint,
new_grp_member_cnt bigint,
off_net_grp_member_cnt bigint,
lost_grp_member_cnt bigint,
owe_grp_member_cnt bigint,
grp_member_income bigint,
vip_cur_day_arr bigint,
cur_day_grp_persn_cust_sms_cnt bigint,
voc_persn_biz_income bigint,
vas_income bigint,
grp_photo_mid_high_cnt bigint,
grp_cust_owe_tot_fee bigint,
grp_cust_chrg_dur bigint )
row format delimited
fields terminated by '\t'
stored as rcfile;

insert into hw_tmp.tmp_tm_gc_grp_d_mid4
select
a.grp_cust_id cust_id,
sum(f.call_cnt) grp_member_call_cnt,
sum(f.call_dur) grp_member_call_dur,
sum(cast(f.gprs_tot_flux as bigint )) grp_member_gprs_flux,
sum(1) grp_member_cnt,
sum(case when b.is_new_user = '0' then 0 else 1 end ) new_grp_member_cnt,
sum(case when b.is_off_net_user = '0' then 0 else 1 end ) off_net_grp_member_cnt,
sum(case when b.is_on_net_user = '0' then 0 else 1 end ) lost_grp_member_cnt,
SUM(case when trim(cast(case when  b.is_on_net_user = '1' or  b.is_off_net_user = '1' then
----(case when coalesce(c.tot_owe_fee,0) ~ '^[0-9]{1,}\$' and not(coalesce(c.tot_owe_fee,0) ~ '^[0]{1,}\$')  then 1 else 0 end )  else 0 end  as varchar )) = '0' then 0 else 1 end )
(case when REGEXP(coalesce(c.tot_owe_fee,0) , '^[0-9]{1,}\$') and not REGEXP(coalesce(c.tot_owe_fee,0) , '^[0]{1,}\$')  then 1 else 0 end )  else 0 end  as varchar(1) )) = '0' then 0 else 1 end )  OWE_GRP_MEMBER_CNT,
sum(g.tot_fee) grp_member_income,
sum(case when d.vip_no is null then 0 else 1 end ) vip_cur_day_arr,
sum(f.p2p_sms_cnt) cur_day_grp_persn_cust_sms_cnt,
sum(g.call_fee) voc_persn_biz_income,
sum(g.tot_fee - g.call_fee) vas_income,
sum(case when d.photo_flg = '0' then 0 else 1 end ) grp_photo_mid_high_cnt,
sum(c.tot_owe_fee) grp_cust_owe_tot_fee,
sum(f.chrg_dur) grp_cust_chrg_dur
from
(
select h.*,row_number() over(partition by subs_id order by subs_id desc) num
from mk.tm_gc_prod_order_d h where statis_date=${hivevar:vi_day}
)  a
inner join mk.tm_sc_user_base_d b
on  a.subs_id = b.subs_id    and b.statis_date =${hivevar:vi_day}
left join  mk.tm_ac_owe_m c
on a.subs_id =c.subs_id  and c.statis_month =${hivevar:vl_month}
left join dwh.td_sc_subs_d d
on a.subs_id =d.subs_id
and d.deal_date =${hivevar:vi_day}
left join hw_tmp.tmp_tm_gc_grp_d_mid1 e
on e.cust_id=a.grp_cust_id
left join mk.tm_ls_user_comm_d f
on a.subs_id = f.subs_id
and f.statis_date = ${hivevar:vi_day}
left join mk.tm_ac_user_acct_d g
on a.subs_id = g.subs_id
and g.statis_date = ${hivevar:vi_day}
where  a.num=1 ----- a.statis_date =${hivevar:vi_day}
and e.cust_id is not null
group by a.grp_cust_id;


drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid5;

create table hw_tmp.tmp_tm_gc_grp_d_mid5(
cust_id varchar(20)
,grp_mid_high_member_cnt bigint
,grp_key_member_arr_cnt bigint
)
row format delimited
fields terminated by '\t'
stored as rcfile;

insert into hw_tmp.tmp_tm_gc_grp_d_mid5
select a.grp_cust_id,
sum(case when a.status = 'stcmNml' then 1 else 0 end),
sum(1)
from dwh.td_gc_group_vip_cust_d a
--join hw_tmp.tmp_tm_gc_grp_d_mid11 b
join (select grp_cust_id
        from mk.tm_gc_prod_order_d
       where statis_date =${hivevar:vi_day}
       group by grp_cust_id ) b
on a.cust_id = b.grp_cust_id
--20200312优化，c表在这个sql中没有意义，注释掉
--left join hw_tmp.tmp_tm_gc_grp_d_mid1 c
--on c.cust_id=a.cust_id
where  a.deal_date =${hivevar:vi_day}
group by a.grp_cust_id;


alter table mk.tm_gc_grp_d drop partition(statis_date=${hivevar:vi_day});

insert into mk.tm_gc_grp_d partition(statis_date=${hivevar:vi_day})
select
a1.region_code
,a1.cust_id
,a1.cust_name
,a1.cust_orgid
,coalesce(a2.respns_cust_mgr ,a1.respns_cust_mgr,'') respns_cust_mgr
,a1.cust_crt_date
,a1.cust_status
,a1.cust_status_date
,a1.group_id
,a1.group_type
,a1.cust_vacation_1
,a1.cust_vacation_2
,a1.stress_trade_type
,0 two_grp_cust_flg
,'' grp_cust_sign_type
,a3.is_grp_cust_arr_cnt
,a3.is_grp_cust_new_cnt
,a3.is_grp_cust_lost_cnt
,'' grp_cust_crdt_val_lvl
,a1.staff_cnt
,'' grp_cust_area_chrt
,a4.grp_member_call_cnt
,a4.grp_member_call_dur
,a4.grp_member_gprs_flux
,a1.addr
,'' zip_code
,a1.checkin_date
,a1.off_net_date
,0 socty_val
,0 now_have_val
,0 ltnc_val
,0 compst_val
,a1.grp_on_net_dur
,'' is_year_photo_ab_grp
,a1.grp_trade_type
,a1.grp_pay_type
,a1.supr_grp_id
,0 grp_biz_sign_cnt
,0 unipay_biz_sign_cnt
,a4.grp_member_cnt
,a4.new_grp_member_cnt
,a4.off_net_grp_member_cnt
,a4.lost_grp_member_cnt
,a4.owe_grp_member_cnt
,0 grp_key_member_cnt
,0 grp_high_val_member_cnt
,a5.grp_mid_high_member_cnt
,a4.grp_member_income
,a4.voc_persn_biz_income
,a4.vas_income
,a4.grp_photo_mid_high_cnt
,0 grp_whl_income
,0 grp_info_income
,0 mas_adc_income
,0 ta_income
,0 std_prd_income
,0 grp_unipay_info_income
,0 unipay_mas_adc_income
,0 unipay_trade_app_income
,0 unipay_std_prd_income
,a4.vip_cur_day_arr
,a4.cur_day_grp_persn_cust_sms_cnt
,a5.grp_key_member_arr_cnt
,'' is_owe_grp_cust
,a4.grp_cust_owe_tot_fee
,'' grp_cust_org_lvl
,a4.grp_cust_chrg_dur
from hw_tmp.tmp_tm_gc_grp_d_mid1 a1
left join hw_tmp.tmp_tm_gc_grp_d_mid2 a2
on a1.cust_id=a2.cust_id
left join hw_tmp.tmp_tm_gc_grp_d_mid3 a3
on a1.cust_id=a3.cust_id
left join hw_tmp.tmp_tm_gc_grp_d_mid4 a4
on a1.cust_id=a4.cust_id
left join hw_tmp.tmp_tm_gc_grp_d_mid5 a5
on a1.cust_id=a5.cust_id;

drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid1;
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid2;
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid3;
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid4;
drop table if EXISTS hw_tmp.tmp_tm_gc_grp_d_mid5;